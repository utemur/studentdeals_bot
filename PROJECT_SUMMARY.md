# –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ StudentDeals Bot

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞**: ~885 (TypeScript)
- **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–π**: 2 (API + Bot)
- **–ú–æ–¥—É–ª–µ–π**: 
  - API: 3 –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞, 3 —Å–µ—Ä–≤–∏—Å–∞
  - Bot: 5 –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, middleware
- **–§–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 7
- **API endpoints**: 3
- **Bot –∫–æ–º–∞–Ω–¥—ã**: 3

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ú–æ–Ω–æ—Ä–µ–ø–æ
- pnpm workspaces –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ apps —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ package.json
- –û–±—â–∏–π TypeScript –∫–æ–Ω—Ñ–∏–≥ –ø–æ–¥—Ö–æ–¥

### API (apps/api)
- **–§—Ä–µ–π–º–≤–æ—Ä–∫**: NestJS 10
- **ORM**: Prisma 5
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: PostgreSQL
- **Email**: Resend SDK
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: JWT
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: class-validator

**–ú–æ–¥—É–ª–∏:**
- `PrismaModule` - –≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ë–î
- `AuthBotModule` - –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
  - `AuthBotController` - 3 POST endpoints
  - `AuthBotService` - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
  - `MailService` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º

### Bot (apps/bot)
- **–§—Ä–µ–π–º–≤–æ—Ä–∫**: Telegraf 4
- **HTTP —Å–µ—Ä–≤–µ—Ä**: Express 4
- **Config**: Zod –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- **Fetch**: node-fetch 3

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `config.ts` - –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è env
- `handlers/` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ –∫–Ω–æ–ø–æ–∫
- `middlewares/rateLimit.ts` - –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞
- `resend.ts` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º (fallback)

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–æ–≤ (SHA256 + pepper)
- ‚úÖ Rate limiting (10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É)
- ‚úÖ TTL –¥–ª—è –∫–æ–¥–æ–≤ (15 –º–∏–Ω—É—Ç)
- ‚úÖ –õ–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ (5)
- ‚úÖ –ö–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–µ JWT (2 –º–∏–Ω—É—Ç—ã)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–µ–∫—Ä–µ—Ç–Ω—ã–π webhook –ø—É—Ç—å

## üìß Email Flow

1. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email –≤ API
2. API –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
3. –ö–æ–¥ —Ö—ç—à–∏—Ä—É–µ—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
4. Resend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∏—Å—å–º–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ–¥ –≤ –±–æ—Ç–∞
6. API –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
7. API –≤—ã–¥–∞—ë—Ç JWT –∏ –º–∞–≥–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É
8. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É "Open my account"

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### User
- `id` (cuid)
- `email` (unique, optional)
- `telegramId` (unique, optional)
- `emailVerified` (boolean)
- `emailVerifiedAt` (datetime)

### VerificationCode
- `id` (cuid)
- `email`
- `codeHash` (SHA256)
- `telegramId`
- `attempts` (int, max 5)
- `expiresAt` (datetime)
- `consumedAt` (datetime, optional)

## üöÄ Deployment

### Render.com
- **Blueprint**: render.yaml –¥–ª—è –∞–≤—Ç–æ–¥–µ–ø–ª–æ—è
- **Build**: `pnpm install && pnpm -w --filter @app build`
- **Start**: `node apps/app/dist/main.js`
- **Health check**: `/healthz`

### Webhook Setup
```bash
pnpm -w --filter @studentdeals/bot set-webhook
```

### Database
```bash
cd apps/api
pnpm prisma:generate
pnpm prisma:migrate deploy
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
.
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.controller.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth-bot/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ   ‚îî‚îÄ‚îÄ bot/
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ config.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ resend.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ middlewares/
‚îÇ       ‚îú‚îÄ‚îÄ package.json
‚îÇ       ‚îî‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ pnpm-workspace.yaml
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ QUICK_START.md
‚îú‚îÄ‚îÄ DEPLOYMENT.md
‚îú‚îÄ‚îÄ CHECKLIST.md
‚îî‚îÄ‚îÄ render.yaml
```

## ‚úÖ Acceptance Criteria

–í—Å–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:

‚úÖ /start –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏  
‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è email —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é  
‚úÖ API endpoints –∑–∞—â–∏—â–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã  
‚úÖ –ú–∞–≥–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –≤—ã–¥–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏  
‚úÖ Polling —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ  
‚úÖ Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ production  
‚úÖ –ù–µ –Ω–∞—Ä—É—à–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–∞–π—Ç  
‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–ª–Ω–∞—è  

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **README.md** - –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞
- **QUICK_START.md** - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- **DEPLOYMENT.md** - –¥–µ—Ç–∞–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π
- **CHECKLIST.md** - —á–µ–∫–ª–∏—Å—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞
- **apps/api/README.md** - API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **apps/bot/README.md** - –±–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üéØ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- Node.js 20+
- TypeScript 5.6
- NestJS 10
- Telegraf 4
- Prisma 5
- PostgreSQL
- Resend
- Express 4
- Zod 3
- pnpm 8+

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL
3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å API –∏ –±–æ—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å flow
6. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ Render
7. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook
8. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ–º–µ–Ω –≤ Resend
9. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ production

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É! üöÄ
